# Legal CMS-MD: Ошибки развертывания и необходимые исправления

## Основные проблемы, обнаруженные при развертывании на MX-Linux сервере

### 1. Проблема с SQLAlchemy metadata атрибутом
**Проблема:** `InvalidRequestError` из-за использования зарезервированного имени `metadata` в моделях
**Файлы:** `app/models/case.py`, `app/models/person.py`
**Решение:** Переименовать атрибут `metadata` в `extra_metadata` с указанием имени колонки:
```python
extra_metadata = Column("metadata", JSON, nullable=True)
```

### 2. Ошибка в events.py с Query параметрами
**Проблема:** `AssertionError` - Query параметры используются для path параметров
**Файл:** `app/api/v1/events.py`
**Решение:** Изменить `Query` на `Path` для year и month параметров

### 3. Проблема с JWT токенами
**Проблема:** JWT токены создаются но не валидируются (401 Unauthorized)
**Причина:** Несоответствие JWT библиотеки и алгоритма кодирования/декодирования
**Файлы:** `app/utils/security.py`, `app/api/deps.py`
**Симптомы:**
- Вход успешный (POST /api/auth/login 200 OK)
- Сразу после этого /api/auth/me возвращает 401
- Токен декодируется вручную но не проходит verify_token

**Необходимые исправления:**
1. Убедиться что используется одна JWT библиотека (PyJWT вместо python-jose)
2. Проверить соответствие SECRET_KEY при кодировании и декодировании
3. Убедиться в правильной обработке исключений PyJWT

### 4. Проблема с refresh токеном в frontend
**Проблема:** Frontend отправляет refresh токен в теле JSON, а бэкенд ожидает в query параметре
**Файл:** `src/api/auth.js`
**Решение:** Изменить способ отправки refresh токена:
```javascript
// Было:
apiClient.post('/api/auth/refresh', { refresh_token: refreshToken })
// Стало:
apiClient.post('/api/auth/refresh', null, { params: { refresh_token: refreshToken } })
```

### 5. Проблемы с развертыванием на MX-Linux (SysVinit)
**Проблемы:**
- Права доступа к файлам PID и логов
- Конфликты портов при перезапуске
- Отсутствие systemd

**Решения:**
- Использовать /tmp для PID и логов вместо /var/run и /var/log
- Правильно обрабатывать kill существующих процессов перед стартом
- Использовать SysVinit скрипты вместо systemd

### 6. Проблема с CORS и frontend конфигурацией
**Проблема:** Frontend пытается подключиться к localhost:8000 вместо серверного IP
**Решение:** Правильно настроить VITE_API_BASE_URL в .env файле frontend

### 7. Проблема с bcrypt версией
**Проблема:** Предупреждение о несовместимости bcrypt версий
**Решение:** Обновить bcrypt до совместимой версии

## Приоритетные исправления для разработчика

1. **Исправить JWT аутентификацию** - критично для работы системы
2. **Исправить refresh токен в frontend** - для автоматического обновления сессий  
3. **Исправить SQLAlchemy модели** - для корректной работы с БД
4. **Исправить events.py** - для работы календаря
5. **Обновить документацию развертывания** с учетом найденных проблем

## Статус развертывания
- ✅ Backend установлен и запущен
- ✅ Frontend собран и настроен  
- ✅ Nginx настроен как reverse proxy
- ✅ SysVinit сервис работает
- ✅ База данных и админ пользователь созданы
- ❌ JWT аутентификация не работает (токены не валидируются)
- ❌ Полный функционал недоступен из-за проблем с аутентификацией

## Рекомендации
1. Провести полное тестирование JWT аутентификации
2. Добавить логирование ошибок JWT для отладки
3. Создать скрипты автоматического развертывания
4. Добавить проверки работоспособности в deployment process
